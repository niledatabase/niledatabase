# Graph RAG Tours Demo

This project demonstrates a Graph RAG (Retrieval-Augmented Generation) implementation for building a tour recommendation guide. It leverages [Nile](https://thenile.dev) for serverless Postgres with built-in tenanted-based sharding (for scale) and partitioning (for performance). It also uses Postgres extensions: `pgvector` for semantic search, and `pgrouting` for graph search to provide context-aware recommendations.

Nile databases come with the `pgvector` and `pgrouting` extensions pre-installed, which are required for this demo.

## How it Works

The process for generating a tour recommendation is as follows:

1. A user asks a question to a specific tour guide (who is a tenant in the system).
2. The user's question is converted into a vector embedding using OpenAI's models.
3. A vector search in the database finds the two most semantically relevant Points of Interest (POIs) to the user's query.
4. A graph search using `pg_routing` finds the shortest path between these two POIs, effectively creating a tour that connects them.
5. The combined list of POIs (the two most relevant ones and those on the path between them) is passed as context to a Large Language Model (LLM).
6. The LLM generates a human-friendly tour recommendation based on the provided context.

This approach combines the strengths of semantic search with graph-based analysis to provide more relevant and coherent recommendations than a simple vector search alone.

## Setup

### 1. Database

This demo uses [Nile](https://thenile.dev) as the serverless Postgres database.

1.  **Sign up for Nile** and create a new database.
2.  **Get your connection string.** You can find it in the Nile dashboard.
3.  **Set the `DATABASE_URL` environment variable** in your shell:

    ```bash
    export DATABASE_URL="<your-nile-db-connection-string>"
    ```

4.  **Run the setup script.** Use `psql` to execute the `setup.sql` file, which creates the necessary tables, indexes, and tenants.

    ```bash
    psql $DATABASE_URL -f setup.sql
    ```

### 2. Python Environment

It is recommended to use a Python virtual environment.

1.  **Create and activate a virtual environment:**

    ```bash
    python3 -m venv venv
    source venv/bin/activate
    ```

2.  **Install the required packages:**

    ```bash
    pip install psycopg2-binary openai numpy pgvector
    ```

3.  **Set your OpenAI API key** as an environment variable:

    ```bash
    export OPENAI_API_KEY="<your-openai-api-key>"
    ```

## 3. Load Data

The `multitenant_load.py` script populates the database with sample data for three different tour operators (tenants). For each tenant, it creates embeddings for their points of interest and links them together in a graph.

To load the data, run the following command:

```bash
python multitenant_load.py
```

## 4. Run the Demo

You can interact with the tour recommendation guide using the `run_guide.py` script.

1. **List available guides (tenants):**

    ```bash
    python run_guide.py --list-guides
    ```

    This will output:

    ```bash
    • SurfCo Travel
    • TrailBlaze Adventures
    • WineCountry Tours
    ```

2. **Ask a question to a specific guide:**

    ```bash
    python run_guide.py --guide "SurfCo Travel" --ask "Where can I surf big waves near San Francisco?"
    ```

    or 

    ```bash
    python run_guide.py -g "TrailBlaze Adventures" -q "I want sick climbing for experts"
    ```

3. **Use the interactive mode:**
    You can also run the script without arguments to enter an interactive mode where it will prompt you for a guide and a question.

    ```bash
    python run_guide.py
    ```

You should see a detailed tour recommendation generated by the LLM based on the Graph RAG results.
